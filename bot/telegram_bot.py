"""
–ú–æ–¥—É–ª—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ Telegram —á–∞—Ç —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Telebot.

–§—É–Ω–∫—Ü–∏—è:

- send_message(name, district, price, description, link, collage_img=None):
    –§–æ—Ä–º–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ —Å —Ç–∞–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏, –∫–∞–∫ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ä–∞–π–æ–Ω, —Ü–µ–Ω–∞, –æ–ø–∏—Å–∞–Ω–∏–µ –∏ —Å—Å—ã–ª–∫–∞.
    –í –∫–∞—á–µ—Å—Ç–≤–µ —Ç–µ–≥–∞ –¥–ª—è —Ä–∞–π–æ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Ö–µ—à—Ç–µ–≥.
    –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (collage_img), –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –∫–∞–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —Å –ø–æ–¥–ø–∏—Å—å—é.
    –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ—Ç ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±—ã—á–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç HTML-—Ä–∞–∑–º–µ—Ç–∫—É –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è.
    –õ–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏ –æ—à–∏–±–∫–∏.
"""


import telebot
from io import BytesIO
import re
from html import escape as hesc  # –∏–º–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
import logging

logger = logging.getLogger(__name__)

from bot.config import BOT_TOKEN, CHAT_ID  # –∏–º–ø–æ—Ä—Ç —Ç–æ–∫–µ–Ω–∞ –∏ ID —á–∞—Ç–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

bot = telebot.TeleBot(BOT_TOKEN)  # —Å–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç –±–æ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–æ–º

def send_message(name, district, price, description, link, collage_img=None):
    # –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å: –ª–∏–±–æ CHAT_ID, –ª–∏–±–æ –ø—É–±–ª–∏—á–Ω—ã–π –∫–∞–Ω–∞–ª –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    DEST_CHAT = CHAT_ID

    # –±–µ—Ä—ë–º –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å —Ä–∞–π–æ–Ω–∞ (–¥–æ " - ") –∏ –æ–±—Ä–µ–∑–∞–µ–º –ø—Ä–æ–±–µ–ª—ã
    loc_text = district.split(" - ", 1)[0].strip()
    # —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–≥, –∑–∞–º–µ–Ω—è—è –≤—Å–µ –Ω–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã –Ω–∞ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è
    tag = re.sub(r"[^\w–ê-–Ø–∞-—è–Ü—ñ–á—ó–Ñ—î“ê“ë0-9]+", "_", loc_text, flags=re.UNICODE)
    # –æ–±—ä–µ–¥–∏–Ω—è–µ–º –ø–æ–¥—Ä—è–¥ –∏–¥—É—â–∏–µ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è –∏ –æ–±—Ä–µ–∑–∞–µ–º –ª–∏—à–Ω–∏–µ —Å –∫–æ–Ω—Ü–æ–≤
    tag = re.sub(r"_+", "_", tag).strip("_")
    # —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Ö–µ—à—Ç–µ–≥ –µ—Å–ª–∏ —Ç–µ–≥ –Ω–µ –ø—É—Å—Ç–æ–π
    hashtag = f"#{tag}" if tag else ""

    # —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –≤—Å—Ç–∞–≤–∫–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ
    name_html = hesc(name)
    loc_html = hesc(loc_text)
    price_html = hesc(price)
    desc_html = hesc((description or "")[:500])  # –æ–±—Ä–µ–∑–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤
    link_html = hesc(link)

    # —Ñ–æ—Ä–º–∏—Ä—É–µ–º HTML-—Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω—É–∂–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    message = (
        f"üè† <b>{name_html}</b>\n"
        f"üìç <b>–†–∞–π–æ–Ω</b>: {hashtag}\n\n"
        f"üí∞ <b>–¶—ñ–Ω–∞</b>: {price_html}\n"
        f"üìù <b>–û–ø–∏—Å</b>: {desc_html}\n"
        f"üîó <a href=\"{link_html}\">–ü–æ—Å–∏–ª–∞–Ω–Ω—è</a>"
    )

    try:
        if collage_img:
            logger.info(f"Sending photo with collage for listing '{name}'")  # –ª–æ–≥–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ç–æ
            bio = BytesIO()  # —Å–æ–∑–¥–∞—ë–º –±–∞–π—Ç–æ–≤—ã–π –ø–æ—Ç–æ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤ –ø–∞–º—è—Ç–∏
            bio.name = 'collage.jpg'  # —É–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ API
            collage_img.save(bio, 'JPEG')  # —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –±–∞–π—Ç–æ–≤—ã–π –ø–æ—Ç–æ–∫
            bio.seek(0)  # —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä –≤ –Ω–∞—á–∞–ª–æ –ø–æ—Ç–æ–∫–∞
            bot.send_photo(DEST_CHAT, photo=bio, caption=message, parse_mode='HTML')  # –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ —Å –ø–æ–¥–ø–∏—Å—å—é
            bio.close()  # –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ç–æ–∫ –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
        else:
            logger.info(f"Sending message without photo for listing '{name}'")  # –ª–æ–≥–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ç–µ–∫—Å—Ç–∞
            bot.send_message(DEST_CHAT, message, parse_mode='HTML', disable_web_page_preview=False)  # –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        logger.info(f"Sent Telegram message for: {name}")  # –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º —É—Å–ø–µ—à–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
    except Exception as e:
        logger.error(f"Error sending Telegram message: {e}")  # –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
